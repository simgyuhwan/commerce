# 요구사항 검증 예시

## 예시 1: 결제 시스템

### 원본 요구사항
```markdown
## 결제
사용자가 주문하면 결제 진행
결제 완료 후 배송
```

### 문제점
- ❌ 예외 시나리오 없음
- ❌ 결제 실패 처리 없음
- ❌ 타임아웃 없음

### 개선안
```markdown
## 결제 프로세스

### 정상 플로우
1. 주문 생성
2. 결제 요청 (PG사 API)
3. 결제 승인
4. 주문 확정
5. 배송 준비

### 실패 시나리오

**타임아웃**:
- 결제 API: 10초
- 초과 시: 3회 재시도 (1초 간격)
- 3회 실패: 주문 취소

**결제 거절**:
- 한도 초과: 사용자 알림
- 카드 정지: 다른 결제 수단 안내
- 네트워크 오류: 자동 재시도

**부분 성공**:
- 포인트 차감 성공, 카드 결제 실패
→ 포인트 복원 (보상 트랜잭션)

### 주문 상태 전이
```
주문 생성 → 결제 대기
결제 대기 → (성공) → 결제 완료
결제 대기 → (실패 3회) → 주문 취소
결제 대기 → (30분 경과) → 자동 취소
```
```

## 예시 2: 재고 관리

### 원본 요구사항
```markdown
재고 부족 시 주문 불가
```

### 문제점
- ❌ 동시성 미고려
- ❌ 재고 차감 시점 불명확

### 개선안
```markdown
## 재고 동시성 제어

### 시나리오
```
재고: 1개
동시 주문: 100명
→ 누가 가져가는가?
```

### 해결 방안

**락 전략**: Optimistic Lock
```java
@Entity
class Product {
    @Version
    private Long version;
    
    private Integer stock;
}
```

**재고 차감 시점**:
1. 주문 생성: 임시 차감 (10분 예약)
2. 결제 완료: 확정 차감
3. 결제 실패/만료: 임시 차감 복원

**재고 부족 처리**:
- 즉시 실패 반환
- "재입고 알림" 신청 가능
- 품절 상품 자동 숨김
```

## 예시 3: API 명세

### 원본 요구사항
```markdown
주문 생성 API
```

### 문제점
- ❌ 엔드포인트 없음
- ❌ 입력/출력 명세 없음
- ❌ 에러 처리 없음

### 개선안
```markdown
## 주문 생성 API

### Request
```http
POST /api/v1/orders
Authorization: Bearer {token}
Content-Type: application/json

{
  "items": [
    {
      "productId": "uuid",      // required
      "quantity": 1,             // required, 1-999
      "options": []              // optional
    }
  ],
  "shippingAddress": {          // required
    "zipCode": "12345",
    "address": "...",
    "phone": "010-1234-5678"
  },
  "paymentMethod": "CARD"       // required: CARD|TRANSFER|KAKAO
}
```

### Response 201 Created
```json
{
  "orderId": "ORD-20250214-000001",
  "status": "PAYMENT_PENDING",
  "totalAmount": 50000,
  "paymentDeadline": "2025-02-14T11:00:00Z"
}
```

### Response 400 Bad Request
```json
{
  "code": "INVALID_QUANTITY",
  "message": "수량은 1-999 사이여야 합니다",
  "field": "items[0].quantity",
  "rejectedValue": 0
}
```

### Response 409 Conflict
```json
{
  "code": "OUT_OF_STOCK",
  "message": "재고가 부족합니다",
  "productId": "uuid",
  "requested": 5,
  "available": 2
}
```
```

## 예시 4: 보안 요구사항

### 원본 요구사항
```markdown
사업자번호와 계좌번호는 암호화
```

### 문제점
- ❌ 알고리즘 불명확
- ❌ Key 관리 방법 없음
- ❌ 다른 민감정보 누락

### 개선안
```markdown
## 개인정보 보호

### 암호화 대상
| 항목 | 알고리즘 | 이유 |
|------|----------|------|
| 사업자번호 | AES-256-GCM | 양방향 (조회 필요) |
| 계좌번호 | AES-256-GCM | 양방향 (조회 필요) |
| 비밀번호 | bcrypt (cost=12) | 단방향 |

### Key 관리
- 환경 변수: `ENCRYPTION_KEY`
- 또는 AWS KMS
- ❌ 코드 내 하드코딩 금지

### 로그 마스킹
```java
log.info("Account: {}", maskAccount(accountNo)); // 1234******89
log.info("Phone: {}", maskPhone(phone));         // 010-****-5678
```

### 탈퇴 처리
- 개인정보: 즉시 삭제 (가명화)
- 주문 이력: 5년 보관 (법적 의무)
- 탈퇴 30일 유예 (복구 가능)
```

## 예시 5: 성능 요구사항

### 원본 요구사항
```markdown
빠른 응답 시간
대량 처리 가능
```

### 문제점
- ❌ 측정 불가능
- ❌ 구체적 목표 없음

### 개선안
```markdown
## 성능 목표

### 응답 시간
| API | 평균 | P95 | P99 |
|-----|------|-----|-----|
| 상품 조회 | 100ms | 200ms | 500ms |
| 주문 생성 | 500ms | 1s | 2s |
| 결제 | 2s | 5s | 10s |

### 처리량
- 평상시 TPS: 100
- 피크 TPS: 1,000
- 동시 접속자: 10,000명

### 캐싱
| 데이터 | TTL | 무효화 |
|--------|-----|--------|
| 상품 목록 | 5분 | 상품 수정 시 |
| 카테고리 | 1시간 | 수동 |
| 세션 | 30분 | 로그아웃 |

### 대용량 처리
- 전체 주문 조회: 페이징 20건
- 엑셀 다운로드: 비동기 (SQS)
- 배치 정산: Chunk 1,000건
- 타임아웃: 10초
```

## 실행 계획 예시

```markdown
## 단계별 실행 계획

### 1단계: Critical 이슈 해결 (1주)
- [ ] 암호화 추가 (사업자번호, 계좌번호)
- [ ] SQL Injection 방어 (PreparedStatement)
- [ ] 동시성 제어 (Optimistic Lock)

### 2단계: Major 이슈 해결 (2주)
- [ ] API 명세 작성
- [ ] 에러 코드 체계 정의
- [ ] 상태 전이 다이어그램

### 3단계: 성능 목표 설정 (1주)
- [ ] SLA 정의
- [ ] 캐싱 전략
- [ ] 모니터링 계획

### 4단계: 재검증 (1주)
- [ ] 완성도 70% 이상 확인
- [ ] 설계 착수
```

## 예상 반론과 대응

### Q: "시간이 부족한데 꼭 다 해야 하나?"
**A**: Critical만 먼저 해결하세요. 보안과 동시성은 나중에 고치기 더 어렵습니다.

### Q: "기획자에게 물어봐야 하는데 연락이 안 돼요."
**A**: 합리적 가정으로 진행하되, 문서에 "가정" 섹션으로 명시하세요.

### Q: "이렇게 하면 개발 기간이 2배로 늘어나요."
**A**: 반대입니다. 개발 중 버그 수정이 더 오래 걸립니다. 지금 30분이 나중의 3시간을 절약합니다.

### Q: "MVP니까 대충 해도 되지 않나?"
**A**: MVP도 보안과 결제는 완벽해야 합니다. 사용자 데이터 유출되면 MVP도 없습니다.